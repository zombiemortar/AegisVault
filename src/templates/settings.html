<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - AegisVault</title>

    <!-- CSS Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script src="{{ url_for('static', filename='auto_lock.js') }}"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{{ url_for('static', filename='aegisvault.jpg') }}" alt="AegisVault Logo" width="40" height="40" class="me-2 navbar-logo">
                <span>AegisVault</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">🏠 Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{{ url_for('add_password') }}">🔑 Add Password</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('vault') }}">🔒 Vault</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">🚪 Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Settings Page -->
    <main class="container mt-4">
        <section class="settings-container rounded p-4">
            <h2>Account Settings</h2>

            <!-- Change Password -->
            <div class="settings-section">
                <h3>Change Password</h3>
                <form action="{{ url_for('change_password') }}" method="POST">
                    <input type="password" name="current_password" placeholder="Current Password" required>
                    <input type="password" name="new_password" placeholder="New Password" required>
                    <input type="password" name="confirm_password" placeholder="Confirm Password" required>
                    <button type="submit" class="btn btn-primary">🔄 Update Password</button>
                </form>
            </div>

            <!-- Manage Account -->
            <div class="settings-section">
                <h3>Account Preferences</h3>
                <a href="{{ url_for('delete_account') }}" class="btn btn-danger">⚠️ Delete Account</a>
            </div>
            
            <div class="settings-section">
                <h3>Backup & Export</h3>
                <form action="{{ url_for('export_backup') }}" method="GET">
                    <button type="submit" class="btn btn-success">💾 Export Passwords</button>
                </form>
            </div>
            
            <div class="settings-section">
                <h3>Import Backup</h3>
                <form action="{{ url_for('import_backup') }}" method="POST" enctype="multipart/form-data">
                    <input type="file" name="backup_file" accept=".json" required>
                    <button type="submit" class="btn btn-warning">📂 Import Backup</button>
                </form>
            </div>

            <!-- Enhanced Appearance Settings -->
            <div class="settings-section">
                <h3>🎨 Appearance & Theme</h3>
                
                <!-- System Preference Detection -->
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" id="follow-system" class="form-check-input">
                        <label class="form-check-label" for="follow-system">
                            🌐 Follow System Theme
                        </label>
                    </div>
                    <small class="form-text text-muted">
                        Automatically switch theme based on your system's light/dark mode preference
                    </small>
                </div>

                <!-- Theme Selection -->
                <div class="mb-3">
                    <label class="form-label">Theme Selection:</label>
                    <div class="d-flex align-items-center gap-2">
                        <div class="theme-switch-wrapper">
                            <input type="checkbox" id="theme-switch">
                            <label class="theme-switch" for="theme-switch">
                                <div class="switch-track">
                                    <div class="switch-thumb">
                                        <span class="theme-icon light">☀️</span>
                                        <span class="theme-icon dark">🌙</span>
                                    </div>
                                    <span class="switch-label light">Light</span>
                                    <span class="switch-label dark">Dark</span>
                                </div>
                            </label>
                        </div>
                        <span id="current-theme-display" class="badge bg-secondary">Dark</span>
                    </div>
                </div>

                <!-- System Preference Info -->
                <div class="mb-3">
                    <div class="alert alert-info">
                        <strong>System Preference:</strong> 
                        <span id="system-preference">Detecting...</span>
                        <br>
                        <small>Your system is currently set to: <span id="system-theme">Detecting...</span></small>
                    </div>
                </div>
            </div>

            <!-- Dashboard Widgets Configuration -->
            <div class="settings-section">
                <h3>📊 Dashboard Widgets</h3>
                <p class="text-muted">Customize which widgets appear on your dashboard</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="widget-security-overview" class="form-check-input" checked>
                            <label class="form-check-label" for="widget-security-overview">
                                🔐 Security Overview
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" id="widget-session-status" class="form-check-input" checked>
                            <label class="form-check-label" for="widget-session-status">
                                ⏰ Session Status
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" id="widget-quick-actions" class="form-check-input" checked>
                            <label class="form-check-label" for="widget-quick-actions">
                                ⚡ Quick Actions
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="widget-password-stats" class="form-check-input" checked>
                            <label class="form-check-label" for="widget-password-stats">
                                📈 Password Statistics
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" id="widget-recent-activity" class="form-check-input">
                            <label class="form-check-label" for="widget-recent-activity">
                                📋 Recent Activity
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" id="widget-security-tips" class="form-check-input">
                            <label class="form-check-label" for="widget-security-tips">
                                💡 Security Tips
                            </label>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary mt-3" onclick="saveWidgetPreferences()">
                    💾 Save Widget Preferences
                </button>
            </div>

            <!-- Auto-Lock Settings -->
            <div class="settings-section">
                <h3>🔒 Auto-Lock Security</h3>
                <form id="auto-lock-form">
                    <div class="mb-3">
                        <label for="session-timeout" class="form-label">Session Timeout (seconds):</label>
                        <input type="number" id="session-timeout" name="session_timeout" min="60" max="3600" class="form-control" value="300">
                        <small class="form-text text-muted">How long to wait before auto-locking due to inactivity (60-3600 seconds)</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" id="auto-lock-enabled" name="auto_lock_enabled" class="form-check-input" checked>
                            <label class="form-check-label" for="auto-lock-enabled">
                                Enable Auto-Lock
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" id="lock-on-tab-inactive" name="lock_on_tab_inactive" class="form-check-input" checked>
                            <label class="form-check-label" for="lock-on-tab-inactive">
                                Lock on Tab Inactivity
                            </label>
                        </div>
                        <small class="form-text text-muted">Lock session when browser tab becomes inactive</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" id="lock-on-window-blur" name="lock_on_window_blur" class="form-check-input" checked>
                            <label class="form-check-label" for="lock-on-window-blur">
                                Lock on Window Blur
                            </label>
                        </div>
                        <small class="form-text text-muted">Lock session when clicking away from the browser window</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" id="lock-on-suspicious" name="lock_on_suspicious_activity" class="form-check-input" checked>
                            <label class="form-check-label" for="lock-on-suspicious">
                                Lock on Suspicious Activity
                            </label>
                        </div>
                        <small class="form-text text-muted">Lock session when unusual activity is detected</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">💾 Save Auto-Lock Settings</button>
                </form>
            </div>

        </section>
    </main>

    <!-- Footer -->
    <footer class="footer bg-dark text-white text-center py-3">
        <div class="container">
            <span>&copy; 2025 AegisVault | Designed by Joseph Sparks | All rights reserved.</span>
        </div>
    </footer>

<script>
// Auto-lock settings form handling
document.addEventListener('DOMContentLoaded', async function() {
    const autoLockForm = document.getElementById('auto-lock-form');
    
    // Load current preferences
    try {
        const response = await fetch('/api/preferences');
        if (response.ok) {
            const preferences = await response.json();
            
            // Populate form fields
            document.getElementById('session-timeout').value = preferences.session_timeout;
            document.getElementById('auto-lock-enabled').checked = preferences.auto_lock_enabled;
            document.getElementById('lock-on-tab-inactive').checked = preferences.lock_on_tab_inactive;
            document.getElementById('lock-on-window-blur').checked = preferences.lock_on_window_blur;
            document.getElementById('lock-on-suspicious').checked = preferences.lock_on_suspicious_activity;
        }
    } catch (error) {
        console.error('Failed to load preferences:', error);
    }
    
    // Handle form submission
    autoLockForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(autoLockForm);
        const preferences = {
            session_timeout: parseInt(formData.get('session_timeout')),
            auto_lock_enabled: formData.get('auto_lock_enabled') === 'on',
            lock_on_tab_inactive: formData.get('lock_on_tab_inactive') === 'on',
            lock_on_window_blur: formData.get('lock_on_window_blur') === 'on',
            lock_on_suspicious_activity: formData.get('lock_on_suspicious_activity') === 'on'
        };
        
        try {
            const response = await fetch('/api/preferences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(preferences)
            });
            
            if (response.ok) {
                // Update the auto-lock manager
                if (window.autoLockManager) {
                    window.autoLockManager.updatePreferences(preferences);
                }
                
                // Show success message
                alert('Auto-lock settings saved successfully!');
            } else {
                alert('Failed to save settings. Please try again.');
            }
        } catch (error) {
            console.error('Error saving preferences:', error);
            alert('Error saving settings. Please try again.');
        }
    });

    // Initialize theme display
    updateThemeDisplay();
    loadWidgetPreferences();
});

// Theme display functions
function updateThemeDisplay() {
    if (window.themeManager) {
        const currentTheme = window.themeManager.getCurrentTheme();
        const followSystem = window.themeManager.isFollowingSystem();
        const systemPref = window.themeManager.getSystemPreference();
        
        // Update theme display
        const themeDisplay = document.getElementById('current-theme-display');
        if (themeDisplay) {
            themeDisplay.textContent = currentTheme.charAt(0).toUpperCase() + currentTheme.slice(1);
            themeDisplay.className = `badge bg-${currentTheme === 'dark' ? 'dark' : 'light'} text-${currentTheme === 'dark' ? 'white' : 'dark'}`;
        }
        
        // Update system preference info
        const systemPrefSpan = document.getElementById('system-preference');
        const systemThemeSpan = document.getElementById('system-theme');
        
        if (systemPrefSpan) {
            systemPrefSpan.textContent = followSystem ? 'Following system' : 'Manual override';
        }
        
        if (systemThemeSpan) {
            systemThemeSpan.textContent = systemPref.charAt(0).toUpperCase() + systemPref.slice(1);
        }
    }
}

// Listen for theme changes
document.addEventListener('themeChanged', function(e) {
    updateThemeDisplay();
});

// Widget preferences functions
function loadWidgetPreferences() {
    const savedWidgets = localStorage.getItem('dashboardWidgets');
    if (savedWidgets) {
        const widgets = JSON.parse(savedWidgets);
        
        // Apply saved preferences
        Object.keys(widgets).forEach(widgetId => {
            const checkbox = document.getElementById(widgetId);
            if (checkbox) {
                checkbox.checked = widgets[widgetId];
            }
        });
    }
}

function saveWidgetPreferences() {
    const widgetCheckboxes = document.querySelectorAll('input[id^="widget-"]');
    const widgets = {};
    
    widgetCheckboxes.forEach(checkbox => {
        widgets[checkbox.id] = checkbox.checked;
    });
    
    localStorage.setItem('dashboardWidgets', JSON.stringify(widgets));
    
    // Show success message
    const button = document.querySelector('button[onclick="saveWidgetPreferences()"]');
    const originalText = button.textContent;
    button.textContent = '✅ Saved!';
    button.disabled = true;
    
    setTimeout(() => {
        button.textContent = originalText;
        button.disabled = false;
    }, 2000);
}
</script>
</body>
</html>