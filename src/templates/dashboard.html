<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AegisVault Dashboard</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- CSS Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script src="{{ url_for('static', filename='auto_lock.js') }}"></script>

    <!-- Bootstrap for Responsive Navbar & Styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark w-100">
        <div class="container-fluid">
            <!-- Logo + Text Side-by-Side -->
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{{ url_for('static', filename='aegisvault.jpg') }}" alt="AegisVault Logo" width="40" height="40" class="me-2 navbar-logo">
                <span>AegisVault</span>
            </a>

            <!-- Navbar Toggler for Mobile -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Right-aligned links -->
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('vault') }}">ğŸ”’ Password Vault</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{{ url_for('add_password') }}">ğŸ”‘ Add Password</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('settings') }}">âš™ï¸ Settings</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('audit_logs') }}">ğŸ“‹ Audit Logs</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">ğŸšª Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="container py-4">
        <!-- Account Overview -->
        <div class="row justify-content-center mb-4" id="widget-account-overview">
            <div class="col-12">
                <div class="dashboard-overview rounded p-4 text-center">
                    <h2>Account Overview</h2>
                    <p>Logged in as: <strong>{{ username }}</strong></p>
                    <p>Total Stored Passwords: <strong>{{ total_passwords }}</strong></p>
                </div>
            </div>
        </div>

        <!-- Quick Actions Widget -->
        <div class="d-flex justify-content-center gap-3 mb-4" id="widget-quick-actions" style="flex-wrap: wrap;">
            <div class="dashboard-card p-4 text-center" style="flex: 1; min-width: 250px; max-width: 350px;">
                <h3>Add New Password</h3>
                <a href="{{ url_for('add_password') }}" class="btn btn-primary mt-3">â• Add</a>
            </div>
            <div class="dashboard-card p-4 text-center" style="flex: 1; min-width: 250px; max-width: 350px;">
                <h3>View Stored Credentials</h3>
                <a href="{{ url_for('vault') }}" class="btn btn-primary mt-3">ğŸ” View</a>
            </div>
            <div class="dashboard-card p-4 text-center" style="flex: 1; min-width: 250px; max-width: 350px;">
                <h3>Modify Your Account</h3>
                <a href="{{ url_for('settings') }}" class="btn btn-primary mt-3">âš™ï¸ Edit</a>
            </div>
        </div>
        
        <!-- Session Status Widget -->
        <div class="row justify-content-center mt-4 mb-4" id="widget-session-status">
            <div class="col-12">
                <div class="dashboard-card p-4">
                    <h3 class="text-center mb-4">â° Session Status</h3>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="security-metric text-center p-3">
                                <h4>Session Status</h4>
                                <div class="metric-value">
                                    <span class="badge bg-success" id="session-status">ğŸŸ¢ Active</span>
                                </div>
                                <small class="text-muted">Current session status</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="security-metric text-center p-3">
                                <h4>Time Remaining</h4>
                                <div class="metric-value" id="time-remaining">--:--</div>
                                <small class="text-muted">Until auto-lock</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="security-metric text-center p-3">
                                <h4>Actions</h4>
                                <button class="btn btn-primary btn-sm" onclick="refreshSession()">ğŸ”„ Refresh Session</button>
                                <small class="text-muted d-block mt-2">Extend session time</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Security Overview Widget -->
        <div class="row justify-content-center mt-4 mb-4" id="widget-security-overview">
            <div class="col-12">
                <div class="dashboard-card p-4">
                    <h3 class="text-center mb-4">ğŸ” Password Security Overview</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="security-metric text-center p-3">
                                <h4>Total Passwords</h4>
                                <div class="metric-value">{{ total_passwords }}</div>
                                <small class="text-muted">Stored credentials</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="security-metric text-center p-3">
                                <h4>Security Status</h4>
                                <div class="metric-value">
                                    <span class="badge bg-success">ğŸ”’ Secure</span>
                                </div>
                                <small class="text-muted">All passwords encrypted</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="{{ url_for('vault') }}" class="btn btn-outline-primary">
                            ğŸ” Analyze All Passwords
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Statistics Widget -->
        <div class="row justify-content-center mt-4 mb-4" id="widget-password-stats">
            <div class="col-12">
                <div class="dashboard-card p-4">
                    <h3 class="text-center mb-4">ğŸ“ˆ Password Statistics</h3>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="security-metric text-center p-3">
                                <h4>Strong Passwords</h4>
                                <div class="metric-value" id="strong-passwords">--</div>
                                <small class="text-muted">High entropy</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="security-metric text-center p-3">
                                <h4>Weak Passwords</h4>
                                <div class="metric-value" id="weak-passwords">--</div>
                                <small class="text-muted">Need attention</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="security-metric text-center p-3">
                                <h4>Average Entropy</h4>
                                <div class="metric-value" id="avg-entropy">--</div>
                                <small class="text-muted">Bits of entropy</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="security-metric text-center p-3">
                                <h4>Security Score</h4>
                                <div class="metric-value" id="security-score">--</div>
                                <small class="text-muted">Overall rating</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Widget -->
        <div class="row justify-content-center mt-4 mb-4" id="widget-recent-activity">
            <div class="col-12">
                <div class="dashboard-card p-4">
                    <h3 class="text-center mb-4">ğŸ“‹ Recent Activity</h3>
                    <div class="activity-list">
                        <div class="activity-item d-flex align-items-center p-3 border-bottom">
                            <div class="activity-icon me-3">ğŸ”‘</div>
                            <div class="activity-content flex-grow-1">
                                <div class="activity-title">Password added</div>
                                <div class="activity-details text-muted">example.com - 2 minutes ago</div>
                            </div>
                        </div>
                        <div class="activity-item d-flex align-items-center p-3 border-bottom">
                            <div class="activity-icon me-3">ğŸ”’</div>
                            <div class="activity-content flex-grow-1">
                                <div class="activity-title">Session refreshed</div>
                                <div class="activity-details text-muted">5 minutes ago</div>
                            </div>
                        </div>
                        <div class="activity-item d-flex align-items-center p-3">
                            <div class="activity-icon me-3">ğŸ“¤</div>
                            <div class="activity-content flex-grow-1">
                                <div class="activity-title">Backup exported</div>
                                <div class="activity-details text-muted">1 hour ago</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Tips Widget -->
        <div class="row justify-content-center mt-4 mb-4" id="widget-security-tips">
            <div class="col-12">
                <div class="dashboard-card p-4">
                    <h3 class="text-center mb-4">ğŸ’¡ Security Tips</h3>
                    <div class="tips-container">
                        <div class="tip-item p-3 mb-3 border-start border-primary">
                            <h5>ğŸ” Use Unique Passwords</h5>
                            <p class="text-muted mb-0">Never reuse passwords across different accounts. Each account should have its own unique, strong password.</p>
                        </div>
                        <div class="tip-item p-3 mb-3 border-start border-warning">
                            <h5>ğŸ”„ Regular Updates</h5>
                            <p class="text-muted mb-0">Update your passwords regularly, especially for critical accounts like banking and email.</p>
                        </div>
                        <div class="tip-item p-3 border-start border-info">
                            <h5>ğŸ” Monitor for Breaches</h5>
                            <p class="text-muted mb-0">Regularly check if your accounts have been compromised in data breaches.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer bg-dark text-white text-center py-3 mt-auto">
        <div class="container">
            <span>&copy; 2025 AegisVault | Designed by Joseph Sparks | All rights reserved.</span>
        </div>
    </footer>

<script>
// Session management functions
async function refreshSession() {
    try {
        const response = await fetch('/api/session/refresh', {
            method: 'POST'
        });
        
        if (response.ok) {
            // Update the auto-lock manager
            if (window.autoLockManager) {
                window.autoLockManager.updateActivity();
            }
            
            // Show success message
            const button = document.querySelector('button[onclick="refreshSession()"]');
            const originalText = button.textContent;
            button.textContent = 'âœ… Refreshed!';
            button.disabled = true;
            
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        }
    } catch (error) {
        console.error('Error refreshing session:', error);
        alert('Failed to refresh session. Please try again.');
    }
}

// Update session status display
function updateSessionDisplay() {
    fetch('/api/session/status')
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('session-status');
            const timeElement = document.getElementById('time-remaining');
            
            if (data.active) {
                statusElement.textContent = 'ğŸŸ¢ Active';
                statusElement.className = 'badge bg-success';
                
                // Format remaining time
                const minutes = Math.floor(data.remaining_time / 60);
                const seconds = data.remaining_time % 60;
                timeElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                statusElement.textContent = 'ğŸ”´ Expired';
                statusElement.className = 'badge bg-danger';
                timeElement.textContent = '00:00';
            }
        })
        .catch(error => {
            console.error('Error fetching session status:', error);
        });
}

// Load password statistics
async function loadPasswordStats() {
    try {
        const response = await fetch('/password_stats');
        if (response.ok) {
            const stats = await response.json();
            
            if (stats.total > 0) {
                // Calculate percentages
                const strongCount = stats.strength_distribution['Very Strong'] + stats.strength_distribution['Strong'];
                const weakCount = stats.strength_distribution['Weak'] + stats.strength_distribution['Very Weak'];
                
                // Update display
                document.getElementById('strong-passwords').textContent = strongCount;
                document.getElementById('weak-passwords').textContent = weakCount;
                document.getElementById('avg-entropy').textContent = stats.average_entropy;
                
                // Calculate security score (0-100)
                const securityScore = Math.round((strongCount / stats.total) * 100);
                document.getElementById('security-score').textContent = securityScore + '%';
                
                // Color code the security score
                const scoreElement = document.getElementById('security-score');
                if (securityScore >= 80) {
                    scoreElement.className = 'metric-value text-success';
                } else if (securityScore >= 60) {
                    scoreElement.className = 'metric-value text-warning';
                } else {
                    scoreElement.className = 'metric-value text-danger';
                }
            }
        }
    } catch (error) {
        console.error('Error loading password stats:', error);
    }
}

// Widget visibility management
function loadWidgetPreferences() {
    const savedWidgets = localStorage.getItem('dashboardWidgets');
    if (savedWidgets) {
        const widgets = JSON.parse(savedWidgets);
        
        // Apply saved preferences
        Object.keys(widgets).forEach(widgetId => {
            const widgetElement = document.getElementById(widgetId);
            if (widgetElement) {
                widgetElement.style.display = widgets[widgetId] ? 'block' : 'none';
            }
        });
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Load widget preferences
    loadWidgetPreferences();
    
    // Load password statistics
    loadPasswordStats();
    
    // Update session display every 10 seconds
    setInterval(updateSessionDisplay, 10000);
    
    // Initial update
    updateSessionDisplay();
});

// Listen for theme changes to update widget styling
document.addEventListener('themeChanged', function(e) {
    // Refresh any theme-dependent elements
    updateSessionDisplay();
});
</script>
</body>
</html>