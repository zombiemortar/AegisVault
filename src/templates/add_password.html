<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Password - AegisVault</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- üîπ Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark w-100">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{{ url_for('static', filename='aegisvault.jpg') }}" alt="AegisVault Logo" width="40" height="40" class="me-2 navbar-logo">
                <span>AegisVault</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">üè† Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('vault') }}">üîí Vault</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('settings') }}">‚öôÔ∏è Settings</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">üö™ Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- üîπ Main Content -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="dashboard-card p-4">
                    <h2 class="mb-4">Add New Password</h2>
                    <form action="{{ url_for('add_password') }}" method="POST">
                        <div class="mb-3">
                            <label for="website" class="form-label">Website URL:</label>
                            <input type="text" id="website" name="website" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="username" class="form-label">Username:</label>
                            <input type="text" id="username" name="username" class="form-control" required>
                        </div>

                        <div class="mb-4">
                            <label for="password" class="form-label">Password:</label>
                            <div class="d-flex align-items-center">
                                <input type="password" id="password" name="password" class="form-control" required oninput="analyzePassword(this.value)">
                                <button type="button" class="toggle-visibility ms-2" onclick="toggleVisibility()">üëÅ</button>
                            </div>
                            
                            <!-- Password Strength Analysis -->
                            <div id="passwordStrength" class="mt-3" style="display: none;">
                                <!-- Strength Meter -->
                                <div class="strength-meter mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="form-label mb-0">Strength:</span>
                                        <span id="strengthLevel" class="badge"></span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Entropy and Score -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="text-center p-2 rounded">
                                            <small class="text-muted d-block">Entropy</small>
                                            <span id="entropyValue" class="badge fs-6"></span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2 rounded">
                                            <small class="text-muted d-block">Score</small>
                                            <span id="strengthScore" class="badge fs-6"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Character Sets -->
                                <div class="character-sets mb-3">
                                    <small class="text-muted d-block mb-2">Character Sets:</small>
                                    <div class="d-flex gap-2">
                                        <span id="lowercase" class="badge bg-secondary">a-z</span>
                                        <span id="uppercase" class="badge bg-secondary">A-Z</span>
                                        <span id="digits" class="badge bg-secondary">0-9</span>
                                        <span id="symbols" class="badge bg-secondary">!@#</span>
                                    </div>
                                </div>
                                
                                <!-- Issues and Suggestions -->
                                <div id="passwordIssues" class="mb-3" style="display: none;">
                                    <small class="text-muted d-block mb-2">Issues:</small>
                                    <ul id="issuesList" class="list-unstyled small"></ul>
                                </div>
                                
                                <div id="passwordSuggestions" class="mb-3" style="display: none;">
                                    <small class="text-muted d-block mb-2">Suggestions:</small>
                                    <ul id="suggestionsList" class="list-unstyled small"></ul>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-100">Save Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleVisibility() {
            let pwdField = document.getElementById("password");
            pwdField.type = (pwdField.type === "password") ? "text" : "password";
        }
        
        // Password strength analysis
        let analysisTimeout;
        
        function analyzePassword(password) {
            // Clear previous timeout
            clearTimeout(analysisTimeout);
            
            // Hide analysis if password is empty
            if (!password) {
                document.getElementById('passwordStrength').style.display = 'none';
                return;
            }
            
            // Debounce the analysis to avoid too many API calls
            analysisTimeout = setTimeout(() => {
                performPasswordAnalysis(password);
            }, 300);
        }
        
        function performPasswordAnalysis(password) {
            fetch('/analyze_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Analysis error:', data.error);
                    return;
                }
                displayPasswordAnalysis(data);
            })
            .catch(error => {
                console.error('Error analyzing password:', error);
            });
        }
        
        function displayPasswordAnalysis(analysis) {
            const strengthDiv = document.getElementById('passwordStrength');
            strengthDiv.style.display = 'block';
            
            // Update strength level and bar
            const strengthLevel = document.getElementById('strengthLevel');
            const strengthBar = document.getElementById('strengthBar');
            const strengthScore = document.getElementById('strengthScore');
            const entropyValue = document.getElementById('entropyValue');
            
            strengthLevel.textContent = analysis.strength_level;
            strengthLevel.className = `badge bg-${getBootstrapColor(analysis.strength_level)}`;
            
            strengthBar.style.width = `${analysis.strength_score}%`;
            strengthBar.className = `progress-bar bg-${getBootstrapColor(analysis.strength_level)}`;
            
            strengthScore.textContent = analysis.strength_score;
            strengthScore.className = `badge bg-${getBootstrapColor(analysis.strength_level)}`;
            
            entropyValue.textContent = analysis.entropy;
            entropyValue.className = `badge bg-${getEntropyColor(analysis.entropy)}`;
            
            // Update character sets
            updateCharacterSets(analysis.character_sets);
            
            // Update issues and suggestions
            updateIssuesAndSuggestions(analysis.issues, analysis.suggestions);
        }
        
        function updateCharacterSets(characterSets) {
            const lowercase = document.getElementById('lowercase');
            const uppercase = document.getElementById('uppercase');
            const digits = document.getElementById('digits');
            const symbols = document.getElementById('symbols');
            
            lowercase.className = `badge ${characterSets.lowercase ? 'bg-success' : 'bg-secondary'}`;
            uppercase.className = `badge ${characterSets.uppercase ? 'bg-success' : 'bg-secondary'}`;
            digits.className = `badge ${characterSets.digits ? 'bg-success' : 'bg-secondary'}`;
            symbols.className = `badge ${characterSets.symbols ? 'bg-success' : 'bg-secondary'}`;
        }
        
        function updateIssuesAndSuggestions(issues, suggestions) {
            const issuesDiv = document.getElementById('passwordIssues');
            const suggestionsDiv = document.getElementById('passwordSuggestions');
            const issuesList = document.getElementById('issuesList');
            const suggestionsList = document.getElementById('suggestionsList');
            
            // Display issues
            if (issues && issues.length > 0) {
                issuesList.innerHTML = '';
                issues.forEach(issue => {
                    const li = document.createElement('li');
                    li.className = 'text-danger mb-1';
                    li.innerHTML = `‚ùå ${issue}`;
                    issuesList.appendChild(li);
                });
                issuesDiv.style.display = 'block';
            } else {
                issuesDiv.style.display = 'none';
            }
            
            // Display suggestions
            if (suggestions && suggestions.length > 0) {
                suggestionsList.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.className = 'text-info mb-1';
                    li.innerHTML = `üí° ${suggestion}`;
                    suggestionsList.appendChild(li);
                });
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function getBootstrapColor(strengthLevel) {
            const colorMap = {
                'Very Strong': 'success',
                'Strong': 'info',
                'Moderate': 'warning',
                'Weak': 'danger',
                'Very Weak': 'danger'
            };
            return colorMap[strengthLevel] || 'secondary';
        }
        
        function getEntropyColor(entropy) {
            if (entropy >= 64) return 'success';
            if (entropy >= 48) return 'info';
            if (entropy >= 32) return 'warning';
            return 'danger';
        }
    </script>

    <footer class="footer bg-dark text-white text-center py-3 mt-auto">
        <div class="container">
            <span>&copy; 2025 AegisVault | Designed by Joseph Sparks | All rights reserved.</span>
        </div>
    </footer>
</body>
</html>