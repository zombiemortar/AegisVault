<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Password - AegisVault</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='theme.js') }}"></script>
    <script src="{{ url_for('static', filename='auto_lock.js') }}"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- üîπ Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark w-100">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{{ url_for('static', filename='aegisvault.jpg') }}" alt="AegisVault Logo" width="40" height="40" class="me-2 navbar-logo">
                <span>AegisVault</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('dashboard') }}">üè† Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('vault') }}">üîí Vault</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('settings') }}">‚öôÔ∏è Settings</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">üö™ Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- üîπ Main Content -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="dashboard-card p-4">
                    <h2 class="mb-4">Add New Password</h2>
                    <form action="{{ url_for('add_password') }}" method="POST">
                        <div class="mb-3">
                            <label for="website" class="form-label">Website URL:</label>
                            <input type="text" id="website" name="website" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="username" class="form-label">Username:</label>
                            <input type="text" id="username" name="username" class="form-control" required>
                        </div>

                        <div class="mb-4">
                            <label for="password" class="form-label">Password:</label>
                            <div class="d-flex align-items-center">
                                <input type="password" id="password" name="password" class="form-control" required oninput="analyzePassword(this.value)">
                                <button type="button" class="toggle-visibility ms-2" onclick="toggleVisibility()">üëÅ</button>
                                <button type="button" class="btn btn-outline-primary ms-2" onclick="openPasswordGenerator()">üîß Generate</button>
                            </div>
                            
                            <!-- Password Strength Analysis -->
                            <div id="passwordStrength" class="mt-3" style="display: none;">
                                <!-- Strength Meter -->
                                <div class="strength-meter mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="form-label mb-0">Strength:</span>
                                        <span id="strengthLevel" class="badge"></span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <!-- Entropy and Score -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <div class="text-center p-2 rounded">
                                            <small class="text-muted d-block">Entropy</small>
                                            <span id="entropyValue" class="badge fs-6"></span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2 rounded">
                                            <small class="text-muted d-block">Score</small>
                                            <span id="strengthScore" class="badge fs-6"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Character Sets -->
                                <div class="character-sets mb-3">
                                    <small class="text-muted d-block mb-2">Character Sets:</small>
                                    <div class="d-flex gap-2">
                                        <span id="lowercase" class="badge bg-secondary">a-z</span>
                                        <span id="uppercase" class="badge bg-secondary">A-Z</span>
                                        <span id="digits" class="badge bg-secondary">0-9</span>
                                        <span id="symbols" class="badge bg-secondary">!@#</span>
                                    </div>
                                </div>
                                
                                <!-- Issues and Suggestions -->
                                <div id="passwordIssues" class="mb-3" style="display: none;">
                                    <small class="text-muted d-block mb-2">Issues:</small>
                                    <ul id="issuesList" class="list-unstyled small"></ul>
                                </div>
                                
                                <div id="passwordSuggestions" class="mb-3" style="display: none;">
                                    <small class="text-muted d-block mb-2">Suggestions:</small>
                                    <ul id="suggestionsList" class="list-unstyled small"></ul>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-100">Save Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleVisibility() {
            let pwdField = document.getElementById("password");
            pwdField.type = (pwdField.type === "password") ? "text" : "password";
        }
        
        // Password strength analysis
        let analysisTimeout;
        
        function analyzePassword(password) {
            // Clear previous timeout
            clearTimeout(analysisTimeout);
            
            // Hide analysis if password is empty
            if (!password) {
                document.getElementById('passwordStrength').style.display = 'none';
                return;
            }
            
            // Debounce the analysis to avoid too many API calls
            analysisTimeout = setTimeout(() => {
                performPasswordAnalysis(password);
            }, 300);
        }
        
        function performPasswordAnalysis(password) {
            fetch('/analyze_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Analysis error:', data.error);
                    return;
                }
                displayPasswordAnalysis(data);
            })
            .catch(error => {
                console.error('Error analyzing password:', error);
            });
        }
        
        function displayPasswordAnalysis(analysis) {
            const strengthDiv = document.getElementById('passwordStrength');
            strengthDiv.style.display = 'block';
            
            // Update strength level and bar
            const strengthLevel = document.getElementById('strengthLevel');
            const strengthBar = document.getElementById('strengthBar');
            const strengthScore = document.getElementById('strengthScore');
            const entropyValue = document.getElementById('entropyValue');
            
            strengthLevel.textContent = analysis.strength_level;
            strengthLevel.className = `badge bg-${getBootstrapColor(analysis.strength_level)}`;
            
            strengthBar.style.width = `${analysis.strength_score}%`;
            strengthBar.className = `progress-bar bg-${getBootstrapColor(analysis.strength_level)}`;
            
            strengthScore.textContent = analysis.strength_score;
            strengthScore.className = `badge bg-${getBootstrapColor(analysis.strength_level)}`;
            
            entropyValue.textContent = analysis.entropy;
            entropyValue.className = `badge bg-${getEntropyColor(analysis.entropy)}`;
            
            // Update character sets
            updateCharacterSets(analysis.character_sets);
            
            // Update issues and suggestions
            updateIssuesAndSuggestions(analysis.issues, analysis.suggestions);
        }
        
        function updateCharacterSets(characterSets) {
            const lowercase = document.getElementById('lowercase');
            const uppercase = document.getElementById('uppercase');
            const digits = document.getElementById('digits');
            const symbols = document.getElementById('symbols');
            
            lowercase.className = `badge ${characterSets.lowercase ? 'bg-success' : 'bg-secondary'}`;
            uppercase.className = `badge ${characterSets.uppercase ? 'bg-success' : 'bg-secondary'}`;
            digits.className = `badge ${characterSets.digits ? 'bg-success' : 'bg-secondary'}`;
            symbols.className = `badge ${characterSets.symbols ? 'bg-success' : 'bg-secondary'}`;
        }
        
        function updateIssuesAndSuggestions(issues, suggestions) {
            const issuesDiv = document.getElementById('passwordIssues');
            const suggestionsDiv = document.getElementById('passwordSuggestions');
            const issuesList = document.getElementById('issuesList');
            const suggestionsList = document.getElementById('suggestionsList');
            
            // Display issues
            if (issues && issues.length > 0) {
                issuesList.innerHTML = '';
                issues.forEach(issue => {
                    const li = document.createElement('li');
                    li.className = 'text-danger mb-1';
                    li.innerHTML = `‚ùå ${issue}`;
                    issuesList.appendChild(li);
                });
                issuesDiv.style.display = 'block';
            } else {
                issuesDiv.style.display = 'none';
            }
            
            // Display suggestions
            if (suggestions && suggestions.length > 0) {
                suggestionsList.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.className = 'text-info mb-1';
                    li.innerHTML = `üí° ${suggestion}`;
                    suggestionsList.appendChild(li);
                });
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function getBootstrapColor(strengthLevel) {
            const colorMap = {
                'Very Strong': 'success',
                'Strong': 'info',
                'Moderate': 'warning',
                'Weak': 'danger',
                'Very Weak': 'danger'
            };
            return colorMap[strengthLevel] || 'secondary';
        }
        
        function getEntropyColor(entropy) {
            if (entropy >= 64) return 'success';
            if (entropy >= 48) return 'info';
            if (entropy >= 32) return 'warning';
            return 'danger';
        }

        // Password Generator Functions
        function openPasswordGenerator() {
            const modal = new bootstrap.Modal(document.getElementById('passwordGeneratorModal'));
            modal.show();
            loadGeneratorOptions();
        }

        function loadGeneratorOptions() {
            fetch('/get_generator_options')
                .then(response => response.json())
                .then(options => {
                    if (options.error) {
                        console.error('Error loading options:', options.error);
                        return;
                    }
                    
                    // Set default values
                    document.getElementById('passwordLength').value = options.length;
                    document.getElementById('lengthDisplay').textContent = options.length;
                    document.getElementById('includeLowercase').checked = options.include_lowercase;
                    document.getElementById('includeUppercase').checked = options.include_uppercase;
                    document.getElementById('includeDigits').checked = options.include_digits;
                    document.getElementById('includeSymbols').checked = options.include_symbols;
                    document.getElementById('avoidSimilar').checked = options.avoid_similar;
                    document.getElementById('avoidAmbiguous').checked = options.avoid_ambiguous;
                })
                .catch(error => {
                    console.error('Error loading generator options:', error);
                });
        }

        function updateLengthDisplay() {
            const length = document.getElementById('passwordLength').value;
            document.getElementById('lengthDisplay').textContent = length;
        }

        function updateWordCountDisplay() {
            const count = document.getElementById('wordCount').value;
            document.getElementById('wordCountDisplay').textContent = count;
        }

        function updatePronounceableLengthDisplay() {
            const length = document.getElementById('pronounceableLength').value;
            document.getElementById('pronounceableLengthDisplay').textContent = length;
        }

        // Handle generator type changes
        document.addEventListener('DOMContentLoaded', function() {
            const generatorTypes = document.querySelectorAll('input[name="generatorType"]');
            generatorTypes.forEach(radio => {
                radio.addEventListener('change', function() {
                    const type = this.value;
                    const options = document.querySelectorAll('.generator-options');
                    
                    options.forEach(option => {
                        option.style.display = 'none';
                    });
                    
                    if (type === 'random') {
                        document.getElementById('randomOptions').style.display = 'block';
                    } else if (type === 'memorable') {
                        document.getElementById('memorableOptions').style.display = 'block';
                    } else if (type === 'pronounceable') {
                        document.getElementById('pronounceableOptions').style.display = 'block';
                    }
                });
            });
        });

        function generatePassword() {
            const generatorType = document.querySelector('input[name="generatorType"]:checked').value;
            let options = { type: generatorType };

            if (generatorType === 'random') {
                options = {
                    ...options,
                    length: parseInt(document.getElementById('passwordLength').value),
                    include_lowercase: document.getElementById('includeLowercase').checked,
                    include_uppercase: document.getElementById('includeUppercase').checked,
                    include_digits: document.getElementById('includeDigits').checked,
                    include_symbols: document.getElementById('includeSymbols').checked,
                    avoid_similar: document.getElementById('avoidSimilar').checked,
                    avoid_ambiguous: document.getElementById('avoidAmbiguous').checked
                };
            } else if (generatorType === 'memorable') {
                options = {
                    ...options,
                    word_count: parseInt(document.getElementById('wordCount').value),
                    separator: document.getElementById('separator').value,
                    include_numbers: document.getElementById('memorableNumbers').checked,
                    include_symbols: document.getElementById('memorableSymbols').checked
                };
            } else if (generatorType === 'pronounceable') {
                options = {
                    ...options,
                    length: parseInt(document.getElementById('pronounceableLength').value),
                    include_numbers: document.getElementById('pronounceableNumbers').checked,
                    include_symbols: document.getElementById('pronounceableSymbols').checked
                };
            }

            fetch('/generate_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(options)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error generating password: ' + data.error);
                    return;
                }
                
                document.getElementById('generatedPassword').value = data.password;
                
                // Display strength information
                const strengthDiv = document.getElementById('generatedPasswordStrength');
                const strengthLevel = document.getElementById('generatedStrengthLevel');
                const entropyValue = document.getElementById('generatedEntropy');
                
                strengthLevel.textContent = data.strength_info.strength_level;
                entropyValue.textContent = data.strength_info.entropy;
                strengthDiv.style.display = 'block';
                
                // Update strength level color
                const colorClass = getBootstrapColor(data.strength_info.strength_level);
                strengthLevel.className = `badge bg-${colorClass}`;
            })
            .catch(error => {
                console.error('Error generating password:', error);
                alert('Error generating password. Please try again.');
            });
        }

        function copyGeneratedPassword() {
            const passwordField = document.getElementById('generatedPassword');
            passwordField.select();
            passwordField.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                // Show feedback
                const copyButton = event.target;
                const originalText = copyButton.textContent;
                copyButton.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    copyButton.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy password:', err);
                alert('Failed to copy password to clipboard');
            }
        }

        function useGeneratedPassword() {
            const generatedPassword = document.getElementById('generatedPassword').value;
            if (generatedPassword) {
                document.getElementById('password').value = generatedPassword;
                document.getElementById('password').type = 'text'; // Show the password
                
                // Trigger password analysis
                analyzePassword(generatedPassword);
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('passwordGeneratorModal'));
                modal.hide();
                
                // Show success message
                alert('Password has been applied to the form!');
            } else {
                alert('Please generate a password first.');
            }
        }
    </script>

    <!-- Password Generator Modal -->
    <div class="modal fade" id="passwordGeneratorModal" tabindex="-1" aria-labelledby="passwordGeneratorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordGeneratorModalLabel">üîß Password Generator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Generator Type Selection -->
                    <div class="mb-4">
                        <label class="form-label">Generator Type:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="generatorType" id="randomType" value="random" checked>
                            <label class="btn btn-outline-primary" for="randomType">Random</label>
                            
                            <input type="radio" class="btn-check" name="generatorType" id="memorableType" value="memorable">
                            <label class="btn btn-outline-primary" for="memorableType">Memorable</label>
                            
                            <input type="radio" class="btn-check" name="generatorType" id="pronounceableType" value="pronounceable">
                            <label class="btn btn-outline-primary" for="pronounceableType">Pronounceable</label>
                        </div>
                    </div>

                    <!-- Random Password Options -->
                    <div id="randomOptions" class="generator-options">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="passwordLength" class="form-label">Length:</label>
                                <input type="range" class="form-range" id="passwordLength" min="8" max="64" value="16" oninput="updateLengthDisplay()">
                                <div class="text-center">
                                    <span id="lengthDisplay" class="badge bg-primary">16</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Character Sets:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeLowercase" checked>
                                    <label class="form-check-label" for="includeLowercase">Lowercase (a-z)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeUppercase" checked>
                                    <label class="form-check-label" for="includeUppercase">Uppercase (A-Z)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeDigits" checked>
                                    <label class="form-check-label" for="includeDigits">Digits (0-9)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeSymbols" checked>
                                    <label class="form-check-label" for="includeSymbols">Symbols (!@#$%^&*)</label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="avoidSimilar" checked>
                                    <label class="form-check-label" for="avoidSimilar">Avoid similar characters (l, 1, I, O, 0)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="avoidAmbiguous" checked>
                                    <label class="form-check-label" for="avoidAmbiguous">Avoid ambiguous characters ({, }, [, ], |, \, /)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Memorable Password Options -->
                    <div id="memorableOptions" class="generator-options" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="wordCount" class="form-label">Word Count:</label>
                                <input type="range" class="form-range" id="wordCount" min="3" max="8" value="4" oninput="updateWordCountDisplay()">
                                <div class="text-center">
                                    <span id="wordCountDisplay" class="badge bg-primary">4</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="separator" class="form-label">Separator:</label>
                                <select class="form-select" id="separator">
                                    <option value="-">- (Hyphen)</option>
                                    <option value="_">_ (Underscore)</option>
                                    <option value=".">.</option>
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Add:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="memorableNumbers" checked>
                                    <label class="form-check-label" for="memorableNumbers">Numbers</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="memorableSymbols" checked>
                                    <label class="form-check-label" for="memorableSymbols">Symbols</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pronounceable Password Options -->
                    <div id="pronounceableOptions" class="generator-options" style="display: none;">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="pronounceableLength" class="form-label">Length:</label>
                                <input type="range" class="form-range" id="pronounceableLength" min="8" max="32" value="12" oninput="updatePronounceableLengthDisplay()">
                                <div class="text-center">
                                    <span id="pronounceableLengthDisplay" class="badge bg-primary">12</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Add:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="pronounceableNumbers" checked>
                                    <label class="form-check-label" for="pronounceableNumbers">Numbers</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="pronounceableSymbols" checked>
                                    <label class="form-check-label" for="pronounceableSymbols">Symbols</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generated Password Display -->
                    <div class="mb-3">
                        <label class="form-label">Generated Password:</label>
                        <div class="input-group">
                            <input type="text" id="generatedPassword" class="form-control" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyGeneratedPassword()">üìã Copy</button>
                        </div>
                    </div>

                    <!-- Password Strength Info -->
                    <div id="generatedPasswordStrength" class="mb-3" style="display: none;">
                        <div class="alert alert-info">
                            <strong>Strength:</strong> <span id="generatedStrengthLevel"></span>
                            <br>
                            <strong>Entropy:</strong> <span id="generatedEntropy"></span> bits
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="generatePassword()">Generate</button>
                    <button type="button" class="btn btn-success" onclick="useGeneratedPassword()">Use Password</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer bg-dark text-white text-center py-3 mt-auto">
        <div class="container">
            <span>&copy; 2025 AegisVault | Designed by Joseph Sparks | All rights reserved.</span>
        </div>
    </footer>
</body>
</html>